<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Galeria CRUD - Vitrine de Celulares</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
    /* Sempre 2 colunas fixas */
    .galeria {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
    .card {
      transform: translateY(20px);
      opacity: 0;
      animation: fadeInUp 0.5s ease-out forwards;
      position: relative;
    }
    @keyframes fadeInUp {
      to { transform: translateY(0); opacity: 1; }
    }
    .image-loading {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Animação da nuvem flutuando */
    @keyframes floatCloud {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .float-cloud {
      animation: floatCloud 2s ease-in-out infinite;
    }

    /* Três pontinhos animados */
    .dots {
      display: flex;
      justify-content: center;
      gap: 4px;
      margin-top: 6px;
    }
    .dot {
      width: 6px;
      height: 6px;
      background-color: #3b82f6;
      border-radius: 50%;
      animation: bounce 1.2s infinite;
    }
    .dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    .dot:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.8); }
      40% { transform: scale(1.2); }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-blue-200 min-h-screen flex flex-col items-center justify-start p-4 sm:p-6">

  <h1 class="text-xl sm:text-2xl font-bold text-center text-blue-600 mb-4 sm:mb-6 flex items-center justify-center gap-2">
    <i data-lucide="smartphone" class="w-6 h-6 sm:w-7 sm:h-7"></i> Vitrine de Celulares - Administração
  </h1>

  <div class="w-full max-w-md bg-white p-4 sm:p-6 rounded-2xl shadow-lg mb-4 sm:mb-6">
    <div class="flex flex-col gap-4">
      <input type="file" id="fileInput" accept="image/*" class="w-full border rounded-lg p-2 sm:p-3 text-sm sm:text-base focus:ring-2 focus:ring-blue-400 outline-none">
      <input type="text" id="modeloInput" placeholder="Nome do modelo do celular" class="w-full border rounded-lg p-2 sm:p-3 text-sm sm:text-base focus:ring-2 focus:ring-blue-400 outline-none">
      <textarea id="descricaoInput" placeholder="Descrição do celular" class="w-full border rounded-lg p-2 sm:p-3 text-sm sm:text-base focus:ring-2 focus:ring-blue-400 outline-none" rows="4"></textarea>
      <button onclick="uploadCelular()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 sm:py-3 px-4 rounded-lg font-medium transition text-sm sm:text-base">
        Adicionar Celular
      </button>
    </div>
  </div>

  <button id="btnAtualizar" onclick="atualizarGaleria()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 sm:py-3 px-4 rounded-lg font-medium transition text-sm sm:text-base mb-4 sm:mb-6">
    Atualizar Vitrine
  </button>

  <div class="w-full max-w-4xl relative">
    <div class="loading-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[9999]" id="galeriaLoading">
      <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-lg max-w-sm w-full text-center">
        <img src="https://cdn-icons-png.flaticon.com/512/414/414927.png" 
             alt="Nuvem flutuante" 
             class="w-12 mx-auto mb-4 float-cloud">
        <p class="text-sm text-gray-600 font-medium">Carregando vitrine</p>
        <div class="dots">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="galeria" id="galeria"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script>
    // === CONFIGURAÇÕES PRINCIPAIS ===
    const CLOUDINARY_CLOUD_NAME = 'dnztotzyj';
    const CLOUDINARY_UPLOAD_PRESET = 'Galeria';  // Exato como no console (Unsigned)
    const CLOUDINARY_API_KEY = '193279191131553';
    const CLOUDINARY_API_SECRET = '_h176LDmDT6PN7-A3pmLAejUffA';  
    const MOCKAPI_URL = 'https://68f458d8b16eb6f46834542c.mockapi.io/Rexord/Galeria';

    const galeriaLoading = document.getElementById('galeriaLoading');

    // === FUNÇÃO: Atualizar Galeria ===
    async function atualizarGaleria() {
      galeriaLoading.classList.remove('hidden');
      try {
        console.log('Iniciando carregamento da galeria...');
        const res = await fetch(MOCKAPI_URL);
        if (!res.ok) throw new Error(`Erro HTTP ${res.status}: ${res.statusText}`);
        const celulares = await res.json();
        console.log('Dados recebidos do MockAPI:', celulares);

        const galeria = document.getElementById('galeria');
        galeria.innerHTML = "";

        celulares.forEach((item, index) => {
          const div = document.createElement('div');
          div.className = 'card bg-white rounded-xl shadow-md overflow-hidden relative';
          div.style.animationDelay = `${index * 0.1}s`;
          div.innerHTML = `
            <div class="image-loading" id="loading-${item.id}">
              <div class="dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
              </div>
            </div>
            <img src="${item.url}" alt="${item.modelo}" class="w-full h-40 sm:h-48 object-cover hover:scale-105 transition-transform duration-300" 
                 onload="document.getElementById('loading-${item.id}').style.display='none'"
                 onerror="console.error('Erro ao carregar imagem:', '${item.url}'); document.getElementById('loading-${item.id}').innerHTML='<p class=\\'text-red-500\\'>Imagem não carregada</p>'">
            <p class="p-3 text-sm sm:text-base font-medium text-gray-800 text-center">${item.modelo}</p>
            <p class="px-3 pb-3 text-sm text-gray-600 text-center">${item.descricao}</p>
            <div class="absolute top-2 right-2 flex gap-2">
              <button class="edit bg-blue-500 hover:bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center transition" onclick="editarCelular('${item.id}', '${item.modelo.replace(/'/g, "\\'")}', '${item.descricao.replace(/'/g, "\\'")}')">
                <i data-lucide="edit" class="w-4 h-4"></i>
              </button>
              <button class="delete bg-red-500 hover:bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center transition" onclick="deletarCelular('${item.id}', '${item.public_id}')">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
              </button>
            </div>
          `;
          galeria.appendChild(div);
        });
        lucide.createIcons();
        console.log('Galeria atualizada com sucesso.');
      } catch (err) {
        console.error('Erro ao carregar a galeria:', err);
        alert("Erro ao carregar a vitrine. Verifique o console do navegador (F12).");
      } finally {
        galeriaLoading.classList.add('hidden');
      }
    }

    // === FUNÇÃO: Upload de Celular (CORRIGIDO: SEM api_key no FormData) ===
    async function uploadCelular() {
      const file = document.getElementById('fileInput').files[0];
      const modelo = document.getElementById('modeloInput').value.trim();
      const descricao = document.getElementById('descricaoInput').value.trim();

      if (!file || !modelo || !descricao) {
        console.warn('Validação falhou: campos obrigatórios ausentes.');
        alert("Selecione uma imagem, insira o nome do modelo e a descrição!");
        return;
      }

      console.log('Iniciando upload para Cloudinary...', { fileName: file.name, modelo, descricao });
      galeriaLoading.classList.remove('hidden');

      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);  // Apenas isso para unsigned!

      const xhr = new XMLHttpRequest();
      xhr.open("POST", `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`);

      xhr.onload = async () => {
        console.log('Resposta Cloudinary - Status:', xhr.status);
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const data = JSON.parse(xhr.responseText);
            console.log('Upload na Cloudinary bem-sucedido:', data);

            if (!data.secure_url || !data.public_id) {
              throw new Error('Resposta da Cloudinary incompleta: faltam secure_url ou public_id');
            }

            console.log('Salvando dados no MockAPI...');
            const mockRes = await fetch(MOCKAPI_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ modelo, descricao, url: data.secure_url, public_id: data.public_id })
            });

            if (!mockRes.ok) throw new Error(`Erro ao salvar no MockAPI: ${mockRes.status}`);
            console.log('Dados salvos no MockAPI com sucesso.');

            // Limpar formulário
            document.getElementById('fileInput').value = "";
            document.getElementById('modeloInput').value = "";
            document.getElementById('descricaoInput').value = "";

            setTimeout(atualizarGaleria, 500);
          } catch (err) {
            console.error('Erro ao processar resposta da Cloudinary ou MockAPI:', err);
            alert("Upload falhou. Verifique o console (F12) para detalhes.");
          }
        } else {
          const erro = JSON.parse(xhr.responseText || '{}');
          console.error('Erro HTTP no upload Cloudinary:', xhr.status, erro);
          alert(`Upload falhou (HTTP ${xhr.status}): ${erro.error?.message || 'Desconhecido'}. Verifique o console.`);
        }
        galeriaLoading.classList.add('hidden');
      };

      xhr.onerror = () => {
        console.error('Erro de rede ao enviar para Cloudinary.');
        alert("Erro de conexão com a Cloudinary. Verifique sua internet.");
        galeriaLoading.classList.add('hidden');
      };

      xhr.send(formData);
    }

    // === FUNÇÃO: Deletar Celular ===
    async function deletarCelular(id, public_id) {
      if (!confirm("Deseja realmente excluir este celular?")) return;

      console.log('Iniciando exclusão...', { id, public_id });
      galeriaLoading.classList.remove('hidden');

      try {
        // Excluir da Cloudinary (requer assinatura)
        const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/destroy`;
        const timestamp = Math.floor(Date.now() / 1000);
        const payload = `public_id=${public_id}&timestamp=${timestamp}${CLOUDINARY_API_SECRET}`;
        const hash = CryptoJS.SHA1(payload).toString();

        const cloudRes = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ public_id, timestamp, api_key: CLOUDINARY_API_KEY, signature: hash })
        });

        if (!cloudRes.ok) {
          const errText = await cloudRes.text();
          throw new Error(`Erro ao excluir da Cloudinary: ${cloudRes.status} - ${errText}`);
        }
        console.log('Imagem excluída da Cloudinary.');

        // Excluir do MockAPI
        const mockRes = await fetch(`${MOCKAPI_URL}/${id}`, { method: "DELETE" });
        if (!mockRes.ok) throw new Error(`Erro ao excluir do MockAPI: ${mockRes.status}`);
        console.log('Registro excluído do MockAPI.');

        setTimeout(atualizarGaleria, 500);
      } catch (err) {
        console.error('Erro na exclusão:', err);
        alert("Erro ao deletar celular. Verifique o console (F12).");
        galeriaLoading.classList.add('hidden');
      }
    }

    // === FUNÇÃO: Editar Celular ===
    async function editarCelular(id, modeloAtual, descricaoAtual) {
      const novoModelo = prompt("Digite o novo nome do modelo:", modeloAtual);
      if (!novoModelo?.trim()) return;
      const novaDescricao = prompt("Digite a nova descrição:", descricaoAtual);
      if (!novaDescricao?.trim()) return;

      console.log('Editando item...', { id, novoModelo, novaDescricao });
      galeriaLoading.classList.remove('hidden');

      try {
        const res = await fetch(`${MOCKAPI_URL}/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ modelo: novoModelo.trim(), descricao: novaDescricao.trim() })
        });

        if (!res.ok) throw new Error(`Erro ao atualizar MockAPI: ${res.status}`);
        console.log('Item atualizado com sucesso.');

        setTimeout(atualizarGaleria, 500);
      } catch (err) {
        console.error('Erro ao editar:', err);
        alert("Erro ao atualizar informações. Verifique o console (F12).");
        galeriaLoading.classList.add('hidden');
      }
    }

    // === INICIALIZAÇÃO ===
    console.log('Sistema inicializado. Carregando galeria...');
    atualizarGaleria();
  </script>
</body>
</html>
